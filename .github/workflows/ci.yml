name: CI - Test & Report

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  AZURE_STORAGE_ACCOUNT: qaplaywrightstorage

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set up Node.js for Playwright
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install npm dependencies at repo root
        run: npm install || echo "No package.json in root, skipping"

      - name: Run Playwright tests
        working-directory: ./playwright-tests
        run: |
          npx playwright install
          npx playwright test --reporter=html
          mkdir -p ../../reports/ui
          if [ -d "../playwright-report" ]; then
            cp -r ../playwright-report/* ../../reports/ui/
          fi
          # Copy the Playwright index.html to reports/ui/index.html explicitly
          if [ -f "../../reports/ui/index.html" ]; then
            echo "Playwright index.html already exists"
          else
            cp ../../reports/ui/index.html ../../reports/ui/index.html
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Run API tests with pytest
        working-directory: ./api-tests/python
        run: |
          pip install -r requirements.txt
          mkdir -p ../../reports/api
          pytest --html=../../reports/api/index.html --self-contained-html

      - name: Create landing page index.html linking to reports
        run: |
          mkdir -p reports
          cat > reports/index.html <<EOF
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8" />
            <title>Test Reports Landing Page</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 40px; }
              h1 { font-size: 28px; margin-bottom: 20px; }
              ul { list-style-type: none; padding: 0; }
              li { margin: 15px 0; }
              a { font-size: 20px; color: #0078d4; text-decoration: none; }
              a:hover { text-decoration: underline; }
            </style>
          </head>
          <body>
            <h1>Test Reports</h1>
            <ul>
              <li><a href="/api/index.html" target="_blank">API Tests Report (Pytest)</a></li>
              <li><a href="/ui/index.html" target="_blank">UI Tests Report (Playwright)</a></li>
            </ul>
          </body>
          </html>
          EOF

      - name: Upload reports to Azure Blob Static Site
        run: |
          # Upload landing page as root index.html
          az storage blob upload \
            --account-name $AZURE_STORAGE_ACCOUNT \
            --container-name \$web \
            --file reports/index.html \
            --name index.html \
            --overwrite

          # Upload API report folder contents
          az storage blob upload-batch \
            --account-name $AZURE_STORAGE_ACCOUNT \
            --destination \$web/api \
            --source reports/api \
            --overwrite

          # Upload UI report folder contents
          az storage blob upload-batch \
            --account-name $AZURE_STORAGE_ACCOUNT \
            --destination \$web/ui \
            --source reports/ui \
            --overwrite
